<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Renting Calculator</title>
  <style>
    :root {
      --gap: 12px;
      --pad: 12px;
      --bg: #f8f9fb;
      --box: #fff;
      --border: #d6dde6;
      --accent: #0b69ff;
    }

    body {
      font-family: Segoe UI, Roboto, Arial, sans-serif;
      margin: 18px;
      background: var(--bg);
      color: #0b1720;
    }

    .card {
      background: var(--box);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
      box-shadow: 0 1px 2px rgba(0, 0, 0, .03);
      max-width: 900px;
      margin: auto;
    }

    .outputs {
      display: flex;
      gap: var(--gap);
      flex-wrap: wrap;
    }

    .output-box {
      flex: 1 1 320px;
      min-height: 20px;
      background: linear-gradient(180deg, #fff, #fbfdff);
      border: none;
      border-radius: 6px;
      padding: var(--pad);
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .output-title {
      font-weight: 600;
      color: #233546;
      font-size: 0.95rem;
    }

    .output-value {
      margin-top: auto;
      font-family: monospace;
      font-size: 1.05rem;
      color: #0b2740;
      white-space: pre-wrap;
    }

    details {
      margin-top: 14px;
    }

    summary {
      cursor: pointer;
      outline: none;
      padding: 8px 10px;
      border-radius: 6px;
      display: inline-block;
      background: transparent;
      color: var(--accent);
      font-weight: 600;
    }

    .inputs {
      margin-top: 10px;
      display: block;
    }

    .inputs-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: var(--gap);
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    label {
      font-size: 0.85rem;
      color: #263238
    }

    input[type="text"],
    input[type="number"],
    input[type="date"],
    select {
      padding: 8px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: #fff;
      font-size: 0.95rem;
      width: 140px;
    }

    .output-box {
      flex: 1 1 320px;
      min-height: 20px;
      background: linear-gradient(180deg, #fff, #fbfdff);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: var(--pad);
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      gap: 6px;
      width: 100%;
    }

    .output-title {
      font-weight: 600;
      color: #233546;
      font-size: 0.95rem;
      text-align: left;
    }

    .output-value {
      margin-top: auto;
      font-family: monospace;
      font-size: 1.05rem;
      color: #0b2740;
      white-space: pre-wrap;
      text-align: left;
      width: 100%;
      padding: 8px;
    }

    /* Responsive */
    @media (max-width:720px) {
      .inputs-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width:480px) {
      .outputs {
        flex-direction: column;
        width: 100%;
      }

      .inputs-grid {
        grid-template-columns: 1fr;
      }

      .output-box {
        width: calc(100% - 32px);  /* Account for padding */
      }

      .output-value {
        font-size: 0.95rem;  /* Slightly smaller font on mobile */
      }

      input[type="text"],
      input[type="number"],
      input[type="date"],
      select {
        width: 100%;
        max-width: 140px;
      }
    }
  </style>
</head>

<body>
  <div class="card" role="region" aria-label="Renting calculator">
    <div class="outputs" aria-hidden="false">
      <div class="output-box" id="outA">
        <div class="output-value" id="output1">--</div>
      </div>
    </div>
  </div>

  <details id="inputsFold" open>
    <summary id="inputsSummary">Show inputs</summary>

    <div class="inputs">
      <div class="inputs-grid">

        <div class="field">
          <label for="dataInicial">DataInicial</label>
          <input id="dataInicial" type="date" value="2025-09-04" />
        </div>

        <div class="field">
          <label for="kmsActuals">Kms Actuals</label>
          <input id="kmsActuals" type="number" value="87000" />
        </div>

        <div class="field">
          <label for="duracioRenting">Duració contracte (mesos)</label>
          <input id="duracioRenting" type="number" min="1" placeholder="12" value="12" />
        </div>

        <div class="field">
          <label for="permanencia">Compromís de permanència (mesos)</label>
          <input id="permanencia" type="number" min="1" placeholder="12" value="6" />
        </div>

        <div class="field">
          <label for="kmsInici">Kms Inicials</label>
          <input id="kmsInici" type="number" value="83240" />
        </div>

        <div class="field">
          <label for="kmsLimit">Kms Limit</label>
          <input id="kmsLimit" type="number" value="10000" />
        </div>

        <div class="field">
          <label for="eurosKm">Euros per Km</label>
          <input id="eurosKm" type="number" step="0.0001" placeholder="0.0001" value="0.0393" />
        </div>

        <div class="field">
          <label for="quotaMensual">Quota Mensual</label>
          <input id="quotaMensual" type="number" step="0.01" value="344.61" />
        </div>



      </div>
    </div>
  </details>
  </div>
  <script>
    // minimal wiring so the two output boxes update live
    const out1 = document.getElementById('output1');

    function fmt(v) { return Number(v || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }

    function update() {
      // Read inputs (use the raw date string for safe parsing)
      const dataInicialStr = document.getElementById('dataInicial').value;
      const dataInicial = dataInicialStr ? new Date(dataInicialStr) : null;
      const duracioRenting = Number(document.getElementById('duracioRenting').value || 0);
      const permanencia = Number(document.getElementById('permanencia').value || 0);
      const kmsActuals = Number(document.getElementById('kmsActuals').value || 0);
      const kmsInici = Number(document.getElementById('kmsInici').value || 0);
      const kmsLimit = Number(document.getElementById('kmsLimit').value || 0);
      const eurosKm = Number(document.getElementById('eurosKm').value || 0);
      const monthlyQuota = Number(document.getElementById('quotaMensual').value || 0);

      const hoy = new Date();
      let diasDesdeInicio = null;
      if (dataInicial) {
        diasDesdeInicio = Math.floor((hoy - dataInicial) / (1000 * 60 * 60 * 24));
      }

      // Derived values
      const totalKms = Math.max(0, kmsActuals - kmsInici);
      const avgDayKM = diasDesdeInicio ? (totalKms / diasDesdeInicio) : totalKms;
      const avgMonths = duracioRenting > 0 ? duracioRenting : (diasDesdeInicio ? Math.max(1, diasDesdeInicio / 30) : 1);

      // Calculate contract end date and remaining days
      let remainingDays = 0;
      let remainingDaysSix = 0;
      let endDate = null;
      if (dataInicial && duracioRenting > 0) {
        endDate = new Date(dataInicial);
        endDate.setMonth(endDate.getMonth() + duracioRenting);
        const totalContractDays = Math.floor((endDate - dataInicial) / (1000 * 60 * 60 * 24));
        const midDate = new Date(dataInicial.getTime() + Math.floor(totalContractDays / 2) * (1000 * 60 * 60 * 24));

        remainingDays = Math.max(0, Math.floor((endDate - hoy) / (1000 * 60 * 60 * 24)));
        remainingDaysSix = Math.max(0, Math.floor((midDate - hoy) / (1000 * 60 * 60 * 24)));
      }

      // Project future kilometers based on current daily rate and remaining days
      const projectedKms = avgDayKM * remainingDays;
      const totalProjectedKms = totalKms + projectedKms;

      const projectedKms6 = avgDayKM * remainingDaysSix;
      const totalProjectedKms6 = totalKms + projectedKms6;

      // Calculate monthly average and excess
      const kmsPorMes = diasDesdeInicio ? (avgDayKM * 30) : (totalKms / avgMonths);
      const kmExceso = Math.max(0, totalProjectedKms - kmsLimit);
      const kmExceso6 = Math.max(0, totalProjectedKms6 - kmsLimit / 2);
      const costeExceso = kmExceso * eurosKm;
      const costeExceso6 = kmExceso6 * eurosKm;

      // Calculate quota-related costs
      const quotaPerDay = monthlyQuota * 12 / 365; // Annual cost divided by days
      const monthsPaid = diasDesdeInicio ? Math.ceil(diasDesdeInicio / 30) : 0;
      const totalPaid = monthlyQuota * monthsPaid + 284.8; //284.8€ is initial deposit fee
      const quotaPerKm = totalKms > 0 ? totalPaid / totalKms : 0;
      const totalToPay6M = monthlyQuota * duracioRenting / 2 - 284.8 + costeExceso6;
      const totalToPay = monthlyQuota * duracioRenting - 284.8 + costeExceso;


      const dataFinal1 = new Date(dataInicial);
      const dataFinal2 = new Date(dataInicial);

      // pel calcul de dies entre fi de contracte o permanencia i data inicial
      dataFinal1.setMonth(dataFinal1.getMonth() + duracioRenting);
      dataFinal2.setMonth(dataFinal2.getMonth() + permanencia);
      
      // Calcular la diferència en mil·lisegons
      const diferenciaDies1 = dataFinal1 - dataInicial;
      const diferenciaDies2 = dataFinal2 - dataInicial;
      console.log(dataFinal1)
      console.log(dataInicial)
      console.log(duracioRenting)
      console.log(permanencia)

      // Convertir la diferència a dies
      const diesFiContracte = Math.round(diferenciaDies1 / (1000 * 60 * 60 * 24));
      const diesFiPermanencia = Math.round(diferenciaDies2 / (1000 * 60 * 60 * 24));




      // Format all information in a single output
      out1.textContent = 
      `
      ${fmt(avgDayKM)} km/dia
      ${fmt(kmsPorMes)} km/mes
      ${fmt(totalKms)} km totals en ${diasDesdeInicio} dies
      ${fmt(totalPaid)} € Pagat en quotes → ${fmt(quotaPerKm)} €/km

      Projecció mig contracte (${remainingDaysSix} dies):
      ${fmt(totalProjectedKms6)} km totals
      ${fmt(kmExceso6)} km excedits amb cost de ${fmt(costeExceso6)} €
      Cost Total: ${fmt(totalToPay6M)} € → ${fmt(totalToPay6M / permanencia)} €/mes → ${fmt(totalToPay6M / diesFiPermanencia)} €/dia → ${fmt(totalToPay6M / totalProjectedKms6)} €/km

      Projecció fi contracte (${remainingDays} dies):
      ${fmt(totalProjectedKms)} km totals
      ${fmt(kmExceso)} km excedits amb cost de ${fmt(costeExceso)} €
      Cost Total: ${fmt(totalToPay)} € → ${fmt(totalToPay / duracioRenting)} €/mes → ${fmt(totalToPay / diesFiContracte)} €/dia → → ${fmt(totalToPay / totalProjectedKms)} €/km`;

    }

    // Listen to all relevant inputs
    document.querySelectorAll('#dataInicial,#duracioRenting,#kmsActuals,#kmsInici,#kmsLimit,#eurosKm,#quotaMensual').forEach(el => {
      el.addEventListener('input', update);
    });

    // initial populate
    update();
  </script>
</body>

</html>